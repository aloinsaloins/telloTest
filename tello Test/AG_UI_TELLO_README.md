# 🚁 Tello AI Controller with AG-UI Protocol

AG-UIプロトコルを使用したDJI Telloドローンの自然言語制御システムです。Mastra AIエージェントとリアルタイム映像ストリーミングを統合した統一インターフェースを提供します。

## 🌟 主な機能

### AG-UIプロトコル統合
- **統一インターフェース**: ドローン制御とAIチャットを一つの画面に統合
- **リアルタイム通信**: AG-UIプロトコルによる効率的なエージェント通信
- **イベントベース**: 非同期イベント処理による応答性の高いUI

### Telloドローン制御
- **自然言語制御**: 日本語での直感的なドローン操作
- **リアルタイム映像**: ライブビデオストリーミング表示
- **安全機能**: バッテリー監視、緊急停止、自動再接続
- **状態管理**: 接続状態、飛行状態、バッテリー残量の監視

### Mastra AIエージェント
- **インテリジェント制御**: Google Geminiを使用した高度な自然言語理解
- **ツール統合**: 11種類のドローン制御ツールを提供
- **安全ガイドライン**: 組み込まれた安全チェックと推奨事項

## 🏗️ システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    AG-UI Frontend                           │
│  ┌─────────────────┐  ┌─────────────────────────────────┐   │
│  │  Video Stream   │  │        AI Chat                  │   │
│  │  Component      │  │      (AG-UI Protocol)          │   │
│  └─────────────────┘  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Mastra Agent Layer                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Tello Agent (Gemini + Tools)                      │   │
│  │  - 自然言語理解                                      │   │
│  │  - 安全チェック                                      │   │
│  │  - ツール実行                                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                Python Web Server                           │
│  ┌─────────────────┐  ┌─────────────────────────────────┐   │
│  │  Tello Control  │  │     Video Streaming             │   │
│  │  (UDP Socket)   │  │     (OpenCV + Base64)          │   │
│  └─────────────────┘  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ UDP/WiFi
                              ▼
                    ┌─────────────────┐
                    │   DJI Tello     │
                    │    Drone        │
                    └─────────────────┘
```

## 🚀 セットアップ手順

### 1. 前提条件

- **Node.js**: v20.9.0以上
- **Python**: 3.8以上
- **DJI Tello**: 充電済みで電源ON
- **WiFi接続**: TelloのWiFiネットワークに接続

### 2. 依存関係のインストール

```bash
# Node.js依存関係
pnpm install

# Python依存関係
pip install -r requirements.txt
```

### 3. 環境変数の設定

`.env`ファイルを作成：

```env
# Google Gemini API Key (Mastraエージェント用)
GOOGLE_GENERATIVE_AI_API_KEY=your_gemini_api_key_here

# Tello設定
TELLO_IP=192.168.10.1
TELLO_PORT=8889
LOCAL_PORT=9000
VIDEO_PORT=11111
```

### 4. Telloドローンの準備

1. **Telloの電源を入れる**
2. **WiFi設定**: デバイスをTelloのWiFiネットワーク（TELLO-XXXXXX）に接続
3. **接続確認**: `ping 192.168.10.1`でTelloとの通信を確認

### 5. システム起動

#### ターミナル1: Python Webサーバー
```bash
python tello_web_server.py
```

#### ターミナル2: React Webアプリケーション
```bash
pnpm web:dev
```

### 6. アクセス

ブラウザで `http://localhost:3000` にアクセス

## 🎮 使用方法

### 基本操作

1. **ドローン接続**: 「Telloに接続」ボタンをクリック
2. **ビデオ開始**: 「ストリーミング開始」ボタンでライブ映像を表示
3. **AI制御**: チャット欄で自然言語コマンドを入力

### 自然言語コマンド例

```
# 基本操作
「ドローンに接続して」
「離陸して」
「前に100cm進んで」
「右に90度回転して」
「上に50cm上がって」
「着陸して」

# 状態確認
「バッテリー残量を教えて」
「ドローンの状態を確認して」

# 映像制御
「ビデオストリーミングを開始して」
「映像を停止して」

# 緊急時
「緊急停止」
「すぐに着陸して」
```

### AG-UIプロトコルの特徴

- **リアルタイム応答**: エージェントからの即座のフィードバック
- **状態同期**: ドローンの状態変更がUIに自動反映
- **エラーハンドリング**: 接続エラーや制御失敗の適切な処理
- **安全機能**: バッテリー低下時の自動警告

## 🛡️ 安全機能

### 自動安全チェック
- **バッテリー監視**: 30%未満で離陸警告
- **接続監視**: 自動再接続機能
- **タイムアウト処理**: コマンド失敗時の自動復旧
- **緊急停止**: 即座のモーター停止機能

### 推奨事項
- 屋内での使用を推奨
- 障害物のない広いスペースで使用
- バッテリー残量30%以上で離陸
- 緊急時は即座に緊急停止を実行

## 🔧 API仕様

### Tello制御API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/connect` | POST | Telloに接続 |
| `/api/disconnect` | POST | Telloから切断 |
| `/api/status` | GET | ドローン状態取得 |
| `/api/battery` | GET | バッテリー残量取得 |
| `/api/takeoff` | POST | 離陸 |
| `/api/land` | POST | 着陸 |
| `/api/emergency` | POST | 緊急停止 |
| `/api/move` | POST | 移動（方向・距離指定） |
| `/api/rotate` | POST | 回転（方向・角度指定） |
| `/api/video/start` | POST | ビデオストリーミング開始 |
| `/api/video/stop` | POST | ビデオストリーミング停止 |
| `/api/video/frame` | GET | 最新フレーム取得 |

### AG-UI API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `/api/copilotkit` | POST | Mastraエージェントとの通信 |

## 🎯 AG-UIプロトコルの利点

### 1. 統一されたユーザーエクスペリエンス
- ドローン制御とAIチャットが一つの画面に統合
- 一貫したデザインとインタラクション

### 2. リアルタイム性
- エージェントからの即座のレスポンス
- ドローン状態の自動更新

### 3. 拡張性
- 新しいツールの簡単な追加
- 他のデバイスとの統合が容易

### 4. 安全性
- エージェントレベルでの安全チェック
- 自動エラー処理と復旧

## 🐛 トラブルシューティング

### よくある問題

1. **Telloに接続できない**
   - WiFi接続を確認
   - Telloの電源状態を確認
   - IPアドレス（192.168.10.1）への疎通確認

2. **ビデオが表示されない**
   - ストリーミングが開始されているか確認
   - ブラウザのコンソールでエラーを確認
   - Telloとの接続状態を確認

3. **AIエージェントが応答しない**
   - Google Gemini API Keyが正しく設定されているか確認
   - ネットワーク接続を確認
   - ブラウザの開発者ツールでAPIエラーを確認

### ログの確認

```bash
# Python サーバーログ
tail -f tello_web_server.log

# ブラウザコンソール
F12 → Console タブ
```

## 📝 開発情報

### 技術スタック

- **Frontend**: React + TypeScript + Vite
- **Backend**: Python + aiohttp + asyncio
- **AI Agent**: Mastra + Google Gemini
- **Protocol**: AG-UI
- **Video**: OpenCV + Base64 streaming
- **Communication**: UDP (Tello) + HTTP (API)

### ファイル構成

```
├── src/
│   ├── components/
│   │   ├── TelloVideoStream.tsx    # ビデオストリーミング
│   │   └── AGUIChat.tsx           # AG-UIチャット
│   ├── mastra/
│   │   └── agents/
│   │       └── tello-agent.ts     # Mastraエージェント
│   ├── api/
│   │   └── copilotkit.ts          # AG-UI API
│   ├── App.tsx                    # メインアプリ
│   └── main.tsx                   # エントリーポイント
├── tello_web_server.py            # Python制御サーバー
├── package.json                   # Node.js依存関係
├── requirements.txt               # Python依存関係
└── vite.config.ts                # Vite設定
```

## 🤝 貢献

プルリクエストや課題報告を歓迎します。

## 📄 ライセンス

MIT License

## 🔗 関連リンク

- [AG-UI Protocol](https://github.com/ag-ui-protocol/ag-ui)
- [Mastra AI](https://mastra.ai/)
- [DJI Tello SDK](https://dl-cdn.ryzerobotics.com/downloads/Tello/Tello%20SDK%202.0%20User%20Guide.pdf) 